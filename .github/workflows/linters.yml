name: Linters
on: 
   workflow_call:
    inputs:
      compare-branch:
        required: true
        type: string      
jobs:
  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
           python-version: '3.10'
      - run: pip install ruff
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/checkout@v4
        with:
          repository: ISISComputingGroup/reusable-workflows
          path: .ibex-shared-workflows
      - name: Changed Files
        run: git diff ${{ inputs.compare-branch }}..HEAD --name-only --diff-filter=ACM -z "*.py" | xargs -0 --no-run-if-empty echo
      - name: Run Ruff Check on Changed Files
        run: git diff ${{ inputs.compare-branch }}..HEAD --name-only --diff-filter=ACM -z "*.py" | xargs -0 --no-run-if-empty ruff check --config .ibex-shared-workflows/ruff.toml
      - name: Run Ruff Format Check on Changed Files 
        run: git diff ${{ inputs.compare-branch }}..HEAD --name-only --diff-filter=ACM -z "*.py" | xargs -0 --no-run-if-empty ruff format --check --config .ibex-shared-workflows/ruff.toml
  pyright:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
           python-version: '3.10'
      - run: pip install unittest-xml-reporting
      - uses: actions/checkout@v4
        with:
           fetch-depth: 0
      - name: install pyright
        run: pip install pyright
      - name: install diff_cover
        run: pip install diff_cover
      - name: install pyright_plugin
        run: pip install git+https://github.com/DiamondLightSource/pyright_diff_quality_plugin.git
      - name: Run Pyright on changes
        run: diff-quality --violations=pyright --compare-branch ${{ inputs.compare-branch }}
